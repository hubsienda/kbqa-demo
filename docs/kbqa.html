<div id="kbqa" style="font-family:system-ui,Segoe UI,Roboto,Arial;max-width:860px;margin:0 auto;padding:16px;border:1px solid #eee;border-radius:14px">
.filter(x=>x.score>0)
.sort((a,b)=>b.score-a.score).slice(0,6);
// group by doc/page and pick top 3 distinct citations
const seen = new Set();
const cites = [];
const chosen = [];
for(const {s} of scored){
const key = s.doc+'-'+s.page;
if(!seen.has(key)){
seen.add(key); cites.push({doc:s.doc, page:s.page, text:s.text});
}
chosen.push(s.text);
if(cites.length>=3) break;
}
const uniqueChosen = Array.from(new Set(chosen)).slice(0,5);
const summary = uniqueChosen.join(' ');
return {summary, cites};
}


document.getElementById('kb-index').addEventListener('click', async ()=>{
const files = Array.from(document.getElementById('kb-files').files||[]).slice(0,3);
if(!files.length){ statusEl.textContent='Please choose 1–3 PDFs.'; return; }
statusEl.textContent = 'Reading PDFs…';
try{
const docs = [];
for(const f of files){ docs.push(await extractPDF(f)); }
buildIndex(docs);
statusEl.textContent = `Indexed ${docs.length} document(s), ${index.length} sentence chunks.`;
askBtn.disabled=false; askBtn.style.background='#111'; askBtn.style.cursor='pointer';
document.getElementById('kb-out').style.display='none';
dbgEl.textContent = JSON.stringify({docs: docNames, chunks: index.length}, null, 2);
}catch(e){
statusEl.textContent = 'Failed to read PDFs.';
console.error(e);
}
});


askBtn.addEventListener('click', ()=>{
const q = document.getElementById('kb-q').value.trim();
if(!q){ return; }
const res = answer(q);
outEl.style.display='block';
const citeHtml = res.cites.map(c=>{
const dn = docNames[c.doc]||`Doc ${c.doc+1}`;
const snip = c.text.length>140 ? c.text.slice(0,137)+'…' : c.text;
return `<div style="margin:6px 0;padding:8px;background:#fff;border:1px solid #eee;border-radius:10px">
<div style="font-size:12px;color:#555"><strong>${dn}</strong> • Page ${c.page}</div>
<div style="margin-top:4px">${snip.replace(/</g,'&lt;')}</div>
</div>`;
}).join('');
outEl.innerHTML = `
<div style="margin-bottom:8px"><strong>Answer (extractive)</strong></div>
<div>${res.summary || '<em>No clear answer found.</em>'}</div>
<div style="margin-top:10px"><strong>Citations</strong></div>
${citeHtml || '<em>No relevant citations.</em>'}
<div style="margin-top:8px;font-size:12px;color:#555">Demo logic: keyword retrieval over sentence chunks; plug a server LLM for abstractive answers.</div>
`;
});
})();
</script>
