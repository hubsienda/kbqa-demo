<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Knowledge Base Q&A (with Citations)</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;padding:24px;background:#fff}
    .card{max-width:860px;margin:0 auto;padding:16px;border:1px solid #eee;border-radius:14px}
    button{cursor:pointer}
    details summary{cursor:pointer}
    pre{white-space:pre-wrap;background:#fcfcfc;border:1px solid #eee;border-radius:10px;padding:10px;overflow:auto}
  </style>
</head>
<body>
  <div id="kbqa" class="card">
    <h3 style="margin:0 0 6px">Knowledge Base Q&A (with Citations)</h3>
    <p style="margin:0 0 12px;color:#444">Upload 1–3 PDFs, then ask a question. The browser performs a light retrieval over sentence chunks and cites exact pages. Everything runs locally.</p>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
      <input id="kb-files" type="file" accept="application/pdf" multiple style="flex:1 1 320px;padding:8px;border:1px solid #ddd;border-radius:10px">
      <button id="kb-index" style="padding:10px 12px;border:0;border-radius:10px;background:#111;color:#fff">Index PDFs</button>
    </div>

    <div id="kb-status" style="font-size:12px;color:#555;margin-bottom:8px"></div>

    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <input id="kb-q" placeholder="Ask a question…" style="flex:1 1 420px;padding:10px;border:1px solid #ddd;border-radius:10px">
      <button id="kb-ask" disabled style="padding:10px 12px;border:0;border-radius:10px;background:#999;color:#fff">Answer</button>
    </div>

    <div id="kb-out" style="display:none;margin-top:12px;padding:12px;background:#f8fafc;border-radius:12px"></div>

    <details style="margin-top:10px"><summary>See the logic (debug)</summary>
      <pre id="kb-json"></pre>
    </details>
  </div>

  <!-- pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>
  <script>
    // (Optional) use a worker for speed
    try {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.js";
    } catch(e) {}

    (function(){
      const statusEl = document.getElementById('kb-status');
      const askBtn   = document.getElementById('kb-ask');
      const outEl    = document.getElementById('kb-out');
      const dbgEl    = document.getElementById('kb-json');
      let index = []; // {doc, page, text, tokens}
      let docNames = [];

      function tokens(s){
        return (s||'').toLowerCase()
          .replace(/[^a-z0-9\s]/g,' ')
          .split(/\s+/).filter(w=>w && !stop.has(w));
      }
      const stop = new Set('a an the and or of for to with on in at by from as is are was were be have has had it this that these those which who whom whose into over under about per each than then thus hence due via vs etc not no yes your our their its if else when while whereas may might can could should will shall would do does did done just more most less least very nearly almost across within without above below before after during around between because until unless'.split(/\s+/));

      async function extractPDF(file){
        const arrayBuf = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({data: arrayBuf}).promise;
        const doc = {name: file.name, pages: []};
        const maxPages = Math.min(pdf.numPages, 40); // safety cap
        for(let p=1; p<=maxPages; p++){
          const page = await pdf.getPage(p);
          const tc = await page.getTextContent();
          const text = tc.items.map(i=>i.str).join(' ');
          doc.pages.push(text);
        }
        return doc;
      }

      function splitSentences(text){
        return (text||'')
          .replace(/\s+/g,' ')
          .split(/(?<=[\.!?])\s+(?=[A-Z0-9])/)
          .map(s=>s.trim()).filter(Boolean);
      }

      function buildIndex(docs){
        index = [];
        docNames = docs.map(d=>d.name);
        docs.forEach((d, di)=>{
          d.pages.forEach((txt, pi)=>{
            splitSentences(txt).forEach(s=>{
              const toks = tokens(s);
              if(toks.length>3){
                index.push({doc:di, page:pi+1, text:s, tokens:toks});
              }
            });
          });
        });
      }

      function scoreSentence(qTokens, sent){
        // simple: term matches + shortness bonus
        const set = new Set(sent.tokens);
        let hits = 0; qTokens.forEach(t=>{ if(set.has(t)) hits++; });
        const lenPenalty = 1 / Math.sqrt(sent.tokens.length);
        return hits + 0.2*lenPenalty;
      }

      function answer(query){
        const qTokens = tokens(query);
        if(!qTokens.length){ return {summary:'', cites:[]}; }
        const scored = index.map(s=>({s,score:scoreSentence(qTokens,s)}))
                            .filter(x=>x.score>0)
                            .sort((a,b)=>b.score-a.score).slice(0,6);
        // group by doc/page and pick top 3 distinct citations
        const seen = new Set();
        const cites = [];
        const chosen = [];
        for(const {s} of scored){
          const key = s.doc+'-'+s.page;
          if(!seen.has(key)){
            seen.add(key); cites.push({doc:s.doc, page:s.page, text:s.text});
          }
          chosen.push(s.text);
          if(cites.length>=3) break;
        }
        const uniqueChosen = Array.from(new Set(chosen)).slice(0,5);
        const summary = uniqueChosen.join(' ');
        return {summary, cites};
      }

      document.getElementById('kb-index').addEventListener('click', async ()=>{
        const files = Array.from(document.getElementById('kb-files').files||[]).slice(0,3);
        if(!files.length){ statusEl.textContent='Please choose 1–3 PDFs.'; return; }
        statusEl.textContent = 'Reading PDFs…';
        try{
          const docs = [];
          for(const f of files){ docs.push(await extractPDF(f)); }
          buildIndex(docs);
          statusEl.textContent = `Indexed ${docs.length} document(s), ${index.length} sentence chunks.`;
          askBtn.disabled=false; askBtn.style.background='#111'; askBtn.style.cursor='pointer';
          document.getElementById('kb-out').style.display='none';
          dbgEl.textContent = JSON.stringify({docs: docNames, chunks: index.length}, null, 2);
        }catch(e){
          statusEl.textContent = 'Failed to read PDFs.';
          console.error(e);
        }
      });

      askBtn.addEventListener('click', ()=>{
        const q = document.getElementById('kb-q').value.trim();
        if(!q){ return; }
        const res = answer(q);
        outEl.style.display='block';
        const citeHtml = res.cites.map(c=>{
          const dn = docNames[c.doc]||`Doc ${c.doc+1}`;
          const snip = c.text.length>140 ? c.text.slice(0,137)+'…' : c.text;
          return `<div style="margin:6px 0;padding:8px;background:#fff;border:1px solid #eee;border-radius:10px">
            <div style="font-size:12px;color:#555"><strong>${dn}</strong> • Page ${c.page}</div>
            <div style="margin-top:4px">${snip.replace(/</g,'&lt;')}</div>
          </div>`;
        }).join('');
        outEl.innerHTML = `
          <div style="margin-bottom:8px"><strong>Answer (extractive)</strong></div>
          <div>${res.summary || '<em>No clear answer found.</em>'}</div>
          <div style="margin-top:10px"><strong>Citations</strong></div>
          ${citeHtml || '<em>No relevant citations.</em>'}
          <div style="margin-top:8px;font-size:12px;color:#555">Demo logic: keyword retrieval over sentence chunks; plug a server LLM for abstractive answers.</div>
        `;
      });
    })();
  </script>
</body>
</html>
